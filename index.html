<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTK Data Collector</title>
    
    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#2196F3">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(90deg, #2196F3, #21CBF3);
            border-radius: 15px 15px 0 0;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.1; transform: scale(1.1); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            margin: 20px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }

        .content {
            padding: 20px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            border-left: 5px solid;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .status.connected {
            background: #e8f5e8;
            color: #2e7d32;
            border-color: #4caf50;
        }

        .status.connecting {
            background: #fff3e0;
            color: #ef6c00;
            border-color: #ff9800;
        }

        .status.disconnected {
            background: #ffebee;
            color: #c62828;
            border-color: #f44336;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #2196f3;
        }

        .data-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .data-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .data-item:hover {
            border-color: #2196F3;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);
        }

        .data-item .label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .data-item .value {
            font-size: 1.4em;
            font-weight: bold;
            color: #2196F3;
        }

        .points-list {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .point-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .point-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 25px 0;
        }

        .map-container {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #666;
            position: relative;
        }

        .map-container::before {
            content: 'üó∫Ô∏è';
            font-size: 3em;
            opacity: 0.3;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
                margin: 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                padding: 12px 25px;
            }
            
            .data-display {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-action:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 30px rgba(76, 175, 80, 0.6);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° RTK Data Collector</h1>
            <p>Sistema Amador de Coleta GNSS/RTK</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('connection')">üîó Conex√£o</button>
            <button class="tab" onclick="showTab('gnss')">üõ∞Ô∏è GNSS</button>
            <button class="tab" onclick="showTab('collection')">üìç Coleta</button>
            <button class="tab" onclick="showTab('data')">üìä Dados</button>
            <button class="tab" onclick="showTab('export')">üíæ Exportar</button>
        </div>

        <div class="content">
            <div id="gnss" class="tab-content">
                <div class="card">
                    <h3>üì± Sistema de Posicionamento do Dispositivo</h3>
                    <div class="form-group">
                        <label>Modo de Localiza√ß√£o:</label>
                        <select class="form-control" id="locationMode" onchange="changeLocationMode()">
                            <option value="device">üì± GNSS do Dispositivo</option>
                            <option value="rtk">üõ∞Ô∏è Receptor RTK Externo (Serial/USB)</option>
                            <option value="combined">üîÑ Combinado (Device + RTK)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Sistemas GNSS Dispon√≠veis:</label>
                        <select class="form-control" id="gnssSystem" onchange="changeGNSSSystem()">
                            <option value="combined">üåç Todos os Sistemas (Recomendado)</option>
                            <option value="gps">üá∫üá∏ GPS (Estados Unidos)</option>
                            <option value="glonass">üá∑üá∫ GLONASS (R√∫ssia)</option>
                            <option value="galileo">üá™üá∫ Galileo (Uni√£o Europeia)</option>
                            <option value="beidou">üá®üá≥ BeiDou (China)</option>
                            <option value="qzss">üáØüáµ QZSS (Jap√£o)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Configura√ß√µes de Precis√£o:</label>
                        <select class="form-control" id="accuracyMode" onchange="changeAccuracyMode()">
                            <option value="high">üéØ Alta Precis√£o (Mais lento, mais bateria)</option>
                            <option value="balanced">‚öñÔ∏è Balanceado (Recomendado)</option>
                            <option value="low">‚ö° Baixa Precis√£o (Mais r√°pido, menos bateria)</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="startDeviceGNSS()">
                            <span id="deviceGnssText">üõ∞Ô∏è Ativar GNSS</span>
                        </button>
                        <button class="btn btn-warning" onclick="calibrateDevice()">üß≠ Calibrar Sensores</button>
                        <button class="btn btn-danger" onclick="stopDeviceGNSS()">‚èπÔ∏è Parar GNSS</button>
                    </div>

                    <div id="gnssStatus" class="status info">
                        ‚ÑπÔ∏è GNSS do dispositivo pronto para uso
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Informa√ß√µes dos Sat√©lites</h3>
                    <div class="data-display">
                        <div class="data-item">
                            <div class="label">GPS</div>
                            <div class="value" id="gpsCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">GLONASS</div>
                            <div class="value" id="glonassCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Galileo</div>
                            <div class="value" id="galileoCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">BeiDou</div>
                            <div class="value" id="beidouCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">QZSS</div>
                            <div class="value" id="qzssCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">HDOP</div>
                            <div class="value" id="hdopValue">--</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìà Hist√≥rico de Precis√£o</h3>
                    <div id="accuracyChart" style="height: 200px; background: #f8f9fa; border-radius: 10px; padding: 20px; text-align: center; color: #666;">
                        üìä Gr√°fico de precis√£o ao longo do tempo<br>
                        <small>Mostra a qualidade do sinal GNSS</small>
                    </div>
                </div>
            </div>

            <div id="connection" class="tab-content active">
                <div class="card">
                    <h3>üîå Receptor GNSS Externo (Serial/USB)</h3>
                    <div class="form-group">
                        <label>Velocidade (Baud Rate):</label>
                        <select class="form-control" id="baudRate">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200" selected>115200</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="connectSerial()">
                            <span id="serialConnectText">üîå Conectar via Serial/USB</span>
                        </button>
                        <button class="btn btn-danger" onclick="disconnect()">‚ùå Desconectar</button>
                    </div>
                    <div id="connectionStatus" class="status disconnected">
                        ‚ùå Desconectado - Conecte o receptor na porta USB e clique para conectar
                    </div>
                </div>
            </div>

            <div id="collection" class="tab-content">
                <div class="card">
                    <h3>üìç Dados GNSS Atuais</h3>
                    <div class="data-display">
                        <div class="data-item">
                            <div class="label">Latitude</div>
                            <div class="value" id="currentLat">--¬∞</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Longitude</div>
                            <div class="value" id="currentLon">--¬∞</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Altitude</div>
                            <div class="value" id="currentAlt">-- m</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Precis√£o</div>
                            <div class="value" id="currentAccuracy">-- m</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Sat√©lites</div>
                            <div class="value" id="satellites">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Qualidade Fix</div>
                            <div class="value" id="activeSystem">INATIVO</div>
                        </div>
                    </div>
                    
                    <div id="positioningStatus" class="status info">
                        ‚ÑπÔ∏è Escolha um sistema de posicionamento na aba GNSS
                    </div>
                </div>

                <div class="card">
                    <h3>üéØ Tipos de Coleta</h3>
                    <div class="button-group">
                        <button class="btn btn-success" onclick="collectPoint('POINT')" id="collectPointBtn">
                            üìç Coletar Ponto
                        </button>
                        <button class="btn btn-success" onclick="startLine()" id="lineBtn">
                            üìè Iniciar Linha
                        </button>
                        <button class="btn btn-success" onclick="startPolygon()" id="polygonBtn">
                            üìê Iniciar Pol√≠gono
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Descri√ß√£o do Ponto:</label>
                        <input type="text" class="form-control" id="pointDescription" placeholder="Ex: Marco, Poste, Edifica√ß√£o...">
                    </div>

                    <div id="collectionStatus" class="status info">
                        ‚ÑπÔ∏è Pronto para coletar - Selecione o tipo de geometria
                    </div>
                </div>

                <div class="map-container">
                    <div style="text-align: center;">
                        üó∫Ô∏è Mapa Interativo<br>
                        <small>Visualiza√ß√£o dos pontos coletados</small>
                    </div>
                </div>
            </div>

            <div id="data" class="tab-content">
                <div class="card">
                    <h3>üìä Resumo da Coleta</h3>
                    <div class="data-display">
                        <div class="data-item">
                            <div class="label">Total Pontos</div>
                            <div class="value" id="totalPoints">0</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Linhas</div>
                            <div class="value" id="totalLines">0</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Pol√≠gonos</div>
                            <div class="value" id="totalPolygons">0</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Precis√£o M√©dia</div>
                            <div class="value" id="avgAccuracy">-- m</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìã Lista de Pontos Coletados</h3>
                    <div class="button-group">
                        <button class="btn btn-warning" onclick="clearAllData()">üóëÔ∏è Limpar Tudo</button>
                        <button class="btn btn-primary" onclick="refreshData()">üîÑ Atualizar</button>
                    </div>
                    <div id="pointsList" class="points-list">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            üìç Nenhum ponto coletado ainda<br>
                            <small>V√° para a aba "Coleta" para come√ßar</small>
                        </div>
                    </div>
                </div>
            </div>

            <div id="export" class="tab-content">
                <div class="card">
                    <h3>üíæ Exportar Dados</h3>
                    <div class="form-group">
                        <label>Nome do Projeto:</label>
                        <input type="text" class="form-control" id="projectName" placeholder="Ex: Levantamento_Area_01">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="exportKMZ()">üó∫Ô∏è Exportar KMZ</button>
                        <button class="btn btn-primary" onclick="exportGeoJSON()">üåê Exportar GeoJSON</button>
                        <button class="btn btn-primary" onclick="exportCSV()">üìä Exportar CSV</button>
                        <button class="btn btn-primary" onclick="exportGeoPackage()">üì¶ Exportar GeoPackage</button>
                    </div>
                    
                    <div id="exportStatus" class="status info">
                        üí° Selecione o formato desejado para exporta√ß√£o
                    </div>
                </div>

                <div class="card">
                    <h3>‚öôÔ∏è Configura√ß√µes de Exporta√ß√£o</h3>
                    <div class="form-group">
                        <label>Sistema de Coordenadas:</label>
                        <select class="form-control" id="coordinateSystem">
                            <option value="WGS84">WGS84 (GPS)</option>
                            <option value="SIRGAS2000">SIRGAS 2000</option>
                            <option value="UTM">UTM</option>
                            <option value="SAD69">SAD 69</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Precis√£o Decimal:</label>
                        <select class="form-control" id="precision">
                            <option value="6">6 casas (¬±1m)</option>
                            <option value="7">7 casas (¬±10cm)</option>
                            <option value="8">8 casas (¬±1cm)</option>
                            <option value="9">9 casas (¬±1mm)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="floating-action" onclick="quickCollect()" title="Coleta R√°pida">
        ‚ö°
    </button>

    <script>
        // Vari√°veis globais para a conex√£o serial
        let port;
        let reader;
        let keepReading = false;

        // Estado global da aplica√ß√£o
        let appState = {
            isConnected: false,
            collectedPoints: [],
            currentGeometry: null,
            geometryType: 'POINT',
            isCollecting: false,
            currentLocation: { lat: 0, lon: 0, alt: 0, accuracy: 0, satellites: 0, fixQuality: 0 },
            locationMode: 'device', // 'device', 'rtk', 'combined'
            gnssType: 'gps', // 'gps', 'glonass', 'galileo', 'beidou', 'qzss', 'combined'
            deviceWatchId: null,
            locationHistory: []
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            initializePWA();
            loadStoredData();
            startLocationUpdates();
            initializeGNSSSystem();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('Service Worker registrado com sucesso:', registration))
                    .catch(error => console.log('Falha no registro do Service Worker:', error));
            }
        });

        function initializePWA() {
            console.log('üöÄ RTK Data Collector PWA Inicializado');
            updateConnectionStatus('disconnected', '‚ùå Aguardando conex√£o com receptor GNSS');
            updateGNSSStatus('info', '‚ÑπÔ∏è Sistema GNSS do dispositivo dispon√≠vel');
        }

        function initializeGNSSSystem() {
            if (navigator.geolocation) {
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isAndroid = /Android/i.test(navigator.userAgent);
                
                if (isMobile && isAndroid) {
                    updateGNSSStatus('connected', '‚úÖ Dispositivo Android detectado - Sistemas GNSS multi-constela√ß√£o dispon√≠veis');
                    document.getElementById('gnssSystem').value = 'combined';
                    document.getElementById('accuracyMode').value = 'balanced';
                    document.getElementById('locationMode').value = 'device';
                } else {
                    updateGNSSStatus('info', '‚ÑπÔ∏è Sistema GNSS b√°sico dispon√≠vel');
                }
                
                requestLocationPermissions();
            } else {
                updateGNSSStatus('disconnected', '‚ùå Sistema GNSS n√£o dispon√≠vel neste dispositivo');
            }
        }

        async function requestLocationPermissions() {
            try {
                if ('permissions' in navigator) {
                    const permission = await navigator.permissions.query({name: 'geolocation'});
                    
                    switch (permission.state) {
                        case 'granted':
                            console.log('‚úÖ Permiss√£o de localiza√ß√£o j√° concedida');
                            break;
                        case 'prompt':
                            console.log('‚ö†Ô∏è Permiss√£o de localiza√ß√£o ser√° solicitada quando necess√°rio');
                            break;
                        case 'denied':
                            updateGNSSStatus('disconnected', '‚ùå Permiss√£o de localiza√ß√£o negada - Ative nas configura√ß√µes');
                            break;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel verificar permiss√µes:', error);
            }
        }
        
        // ================================
        // CONEX√ÉO SERIAL/USB (NOVO)
        // ================================
        async function connectSerial() {
            if (!("serial" in navigator)) {
                alert("Seu navegador n√£o suporta a Web Serial API. Use o Google Chrome ou Microsoft Edge na vers√£o mais recente.");
                return;
            }

            if (appState.isConnected) {
                updateConnectionStatus('info', 'J√° conectado. Desconecte primeiro para iniciar uma nova conex√£o.');
                return;
            }

            const connectBtn = document.getElementById('serialConnectText');
            connectBtn.innerHTML = '<span class="loading"></span>Conectando...';
            updateConnectionStatus('connecting', 'üîÑ Aguardando sele√ß√£o da porta serial...');

            try {
                port = await navigator.serial.requestPort();
                keepReading = true;
                appState.isConnected = true;
                
                const baudRate = parseInt(document.getElementById('baudRate').value, 10);
                await port.open({ baudRate: baudRate });
                
                updateConnectionStatus('connected', '‚úÖ Conectado ao receptor GNSS via Serial/USB');
                connectBtn.textContent = '‚úÖ Conectado';

                readFromSerial();

            } catch (error) {
                console.error('‚ùå Erro na conex√£o Serial:', error);
                updateConnectionStatus('disconnected', '‚ùå Erro: ' + error.message);
                connectBtn.textContent = 'üîå Conectar via Serial/USB';
                appState.isConnected = false;
            }
        }

        async function readFromSerial() {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();

            let lineBuffer = '';

            while (port.readable && keepReading) {
                try {
                    const { value, done } = await reader.read();
                    if (done) {
                        break;
                    }

                    lineBuffer += value;
                    let lines = lineBuffer.split('\r\n');
                    
                    // A √∫ltima linha pode estar incompleta, ent√£o guarde-a
                    lineBuffer = lines.pop(); 
                    
                    lines.forEach(line => {
                        if (line.startsWith('$GNGGA') || line.startsWith('$GPGGA')) {
                            parseNMEA_GGA(line);
                        }
                    });

                } catch (error) {
                    console.error("Erro ao ler da porta serial:", error);
                    updateConnectionStatus('disconnected', '‚ùå Erro de leitura. O dispositivo foi desconectado?');
                    break;
                }
            }
            
            reader.releaseLock();
            await readableStreamClosed.catch(() => { /* Ignorar erros de cancelamento */ });
        }

        function parseNMEA_GGA(sentence) {
            const parts = sentence.split(',');
            if (parts.length < 10) return; // Senten√ßa GGA inv√°lida

            const fixQuality = parseInt(parts[6], 10);
            if (fixQuality === 0) { // Sem fix, dados n√£o confi√°veis
                updateLocationDisplayWithStatus("Sem Sinal", 0);
                return;
            }
            
            // Latitude
            const latValue = parseFloat(parts[2]);
            const latDirection = parts[3];
            let latitude = Math.floor(latValue / 100) + (latValue % 100) / 60;
            if (latDirection === 'S') latitude *= -1;

            // Longitude
            const lonValue = parseFloat(parts[4]);
            const lonDirection = parts[5];
            let longitude = Math.floor(lonValue / 100) + (lonValue % 100) / 60;
            if (lonDirection === 'W') longitude *= -1;

            const satellites = parseInt(parts[7], 10);
            const hdop = parseFloat(parts[8]);
            const altitude = parseFloat(parts[9]);

            // Precis√£o estimada com base no HDOP e status RTK
            let accuracy = hdop * 2; // Estimativa para fix normal
            if (fixQuality === 4 || fixQuality === 5) { // RTK Fixed ou Float
                accuracy = 0.02 + (hdop * 0.05); // Estimativa de alta precis√£o
            }

            appState.currentLocation = {
                lat: latitude,
                lon: longitude,
                alt: altitude,
                accuracy: accuracy,
                satellites: satellites,
                hdop: hdop,
                fixQuality: fixQuality
            };

            if (appState.locationMode === 'rtk' || appState.locationMode === 'combined') {
                updateLocationDisplay();
            }
        }
        
        async function disconnect() {
            keepReading = false;
            
            if (reader) {
                await reader.cancel();
            }

            if (port) {
                await port.close();
                port = null;
            }
            
            appState.isConnected = false;
            document.getElementById('serialConnectText').textContent = 'üîå Conectar via Serial/USB';
            updateConnectionStatus('disconnected', '‚ùå Desconectado do receptor GNSS');
        }

        // ================================
        // GNSS DO DISPOSITIVO (l√≥gica existente, sem altera√ß√µes)
        // ================================

        function changeLocationMode() {
            const mode = document.getElementById('locationMode').value;
            appState.locationMode = mode;
            
            updateGNSSStatus('info', `üì± Modo alterado para: ${getLocationModeText(mode)}`);
            
            if (mode === 'device' || mode === 'combined') {
                startDeviceGNSS();
            }
        }

        function changeGNSSSystem() {
            const system = document.getElementById('gnssSystem').value;
            appState.gnssType = system;
            
            updateGNSSStatus('info', `üõ∞Ô∏è Sistema GNSS: ${getGNSSSystemText(system)}`);
            
            if (appState.deviceWatchId) {
                stopDeviceGNSS();
                startDeviceGNSS();
            }
        }

        function changeAccuracyMode() {
            const mode = document.getElementById('accuracyMode').value;
            updateGNSSStatus('info', `üéØ Modo de precis√£o alterado: ${getAccuracyModeText(mode)}`);
            
            if (appState.deviceWatchId) {
                stopDeviceGNSS();
                startDeviceGNSS();
            }
        }

        async function startDeviceGNSS() {
            if (!navigator.geolocation) {
                updateGNSSStatus('disconnected', '‚ùå Geolocaliza√ß√£o n√£o suportada neste dispositivo');
                return;
            }

            const button = document.getElementById('deviceGnssText');
            button.innerHTML = '<span class="loading"></span>Iniciando...';
            updateGNSSStatus('connecting', 'üîÑ Iniciando sistema GNSS do dispositivo...');

            try {
                const options = getLocationOptions();
                
                const position = await getCurrentPositionAsync(options);
                handleDeviceLocation(position);
                
                appState.deviceWatchId = navigator.geolocation.watchPosition(
                    handleDeviceLocation,
                    handleLocationError,
                    options
                );
                
                button.textContent = '‚úÖ GNSS Ativo';
                updateGNSSStatus('connected', `‚úÖ ${getGNSSSystemText(appState.gnssType)} ativo - Coletando posi√ß√µes`);
                
            } catch (error) {
                console.error('‚ùå Erro ao iniciar GNSS:', error);
                updateGNSSStatus('disconnected', '‚ùå Erro: ' + error.message);
                button.textContent = 'üõ∞Ô∏è Ativar GNSS';
            }
        }

        function getCurrentPositionAsync(options) {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        function getLocationOptions() {
            const accuracyMode = document.getElementById('accuracyMode').value;
            
            let options = {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 15000
            };

            switch (accuracyMode) {
                case 'high':
                    options.enableHighAccuracy = true;
                    options.timeout = 30000;
                    options.maximumAge = 0;
                    break;
                case 'balanced':
                    options.enableHighAccuracy = true;
                    options.timeout = 15000;
                    options.maximumAge = 5000;
                    break;
                case 'low':
                    options.enableHighAccuracy = false;
                    options.timeout = 10000;
                    options.maximumAge = 30000;
                    break;
            }
            return options;
        }

        function handleDeviceLocation(position) {
            const coords = position.coords;
            
            if (appState.locationMode === 'device' || appState.locationMode === 'combined') {
                appState.currentLocation = {
                    lat: coords.latitude,
                    lon: coords.longitude,
                    alt: coords.altitude || 0,
                    accuracy: coords.accuracy || 999,
                    satellites: estimateSatelliteCount(coords.accuracy),
                    hdop: calculateHDOP(coords.accuracy),
                    fixQuality: 1, // Simula um fix de GPS padr√£o
                    timestamp: new Date(position.timestamp)
                };
                
                appState.locationHistory.push({ ...appState.currentLocation, timestamp: Date.now() });
                if (appState.locationHistory.length > 100) appState.locationHistory.shift();
                
                updateLocationDisplay();
            }
        }

        function handleLocationError(error) {
            let errorMessage = '';
            switch (error.code) {
                case error.PERMISSION_DENIED: errorMessage = 'Permiss√£o de localiza√ß√£o negada'; break;
                case error.POSITION_UNAVAILABLE: errorMessage = 'Posi√ß√£o indispon√≠vel - verifique se est√° ao ar livre'; break;
                case error.TIMEOUT: errorMessage = 'Timeout na obten√ß√£o da localiza√ß√£o'; break;
                default: errorMessage = 'Erro desconhecido na localiza√ß√£o'; break;
            }
            console.error('‚ùå Erro de localiza√ß√£o:', error);
            updateGNSSStatus('disconnected', '‚ùå ' + errorMessage);
        }

        function estimateSatelliteCount(accuracy) {
            if (accuracy < 3) return 12;
            if (accuracy < 5) return 8;
            if (accuracy < 10) return 6;
            if (accuracy < 20) return 4;
            return 3;
        }

        function calculateHDOP(accuracy) {
            const hdop = Math.min(Math.max(1, accuracy / 2), 10);
            return hdop.toFixed(1);
        }
        
        // ================================
        // ATUALIZA√á√ÉO DA INTERFACE (MODIFICADO)
        // ================================

        function updateLocationDisplay() {
            const location = appState.currentLocation;
            
            document.getElementById('currentLat').textContent = location.lat.toFixed(8) + '¬∞';
            document.getElementById('currentLon').textContent = location.lon.toFixed(8) + '¬∞';
            document.getElementById('currentAlt').textContent = location.alt.toFixed(2) + ' m';
            document.getElementById('currentAccuracy').textContent = location.accuracy.toFixed(2) + ' m';
            document.getElementById('satellites').textContent = location.satellites;
            document.getElementById('hdopValue').textContent = location.hdop || '--';
            
            let activeSystemText = 'INATIVO';
            let statusClass = 'disconnected';
            let statusMessage = 'Nenhum sistema de posicionamento ativo';
            
            if (appState.locationMode === 'device' && appState.deviceWatchId) {
                activeSystemText = 'GNSS INTERNO';
                statusClass = 'connected';
                statusMessage = `‚úÖ Sistema GNSS do dispositivo ativo - ${getGNSSSystemText(appState.gnssType)}`;
            } else if (appState.locationMode === 'rtk' && appState.isConnected) {
                activeSystemText = getFixQualityText(location.fixQuality);
                statusClass = location.fixQuality >= 2 ? 'connected' : 'connecting';
                statusMessage = `‚úÖ Receptor Externo ativo - Qualidade: ${activeSystemText}`;
            } else if (appState.locationMode === 'combined') {
                 if (appState.deviceWatchId || appState.isConnected) {
                    activeSystemText = 'COMBINADO';
                    statusClass = 'connected';
                    statusMessage = '‚úÖ Sistema combinado (Device + RTK) ativo';
                }
            }
            
            document.getElementById('activeSystem').textContent = activeSystemText;
            document.getElementById('positioningStatus').className = `status ${statusClass}`;
            document.getElementById('positioningStatus').textContent = statusMessage;
        }

        function updateLocationDisplayWithStatus(statusText, fixQuality) {
            document.getElementById('activeSystem').textContent = statusText;
            document.getElementById('positioningStatus').className = 'status disconnected';
            document.getElementById('positioningStatus').textContent = `‚ùå ${statusText}`;
            appState.currentLocation.fixQuality = fixQuality;
        }

        function getFixQualityText(quality) {
            switch(quality) {
                case 1: return 'SINGLE';
                case 2: return 'DGPS';
                case 4: return 'RTK FIXED';
                case 5: return 'RTK FLOAT';
                default: return 'SEM FIX';
            }
        }
        
        // ... (o restante do c√≥digo JavaScript permanece o mesmo) ...
        // Fun√ß√µes como calibrateDevice, stopDeviceGNSS, collectPoint, etc., n√£o precisam de altera√ß√£o
        // A l√≥gica de coleta j√° usa o appState.currentLocation que agora √© atualizado pela fonte correta.
        
        function calibrateDevice() {
            updateGNSSStatus('connecting', 'üß≠ Calibrando sensores do dispositivo...');
            if (typeof DeviceOrientationEvent !== 'undefined') {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') performCalibration();
                            else updateGNSSStatus('info', '‚ö†Ô∏è Permiss√£o de orienta√ß√£o necess√°ria para calibra√ß√£o');
                        });
                } else {
                    performCalibration();
                }
            } else {
                updateGNSSStatus('info', 'üì± Calibra√ß√£o autom√°tica n√£o suportada neste dispositivo');
            }
        }

        function performCalibration() {
            let calibrationSteps = 0;
            const maxSteps = 10;
            const calibrationInterval = setInterval(() => {
                calibrationSteps++;
                updateGNSSStatus('connecting', `üß≠ Calibrando... ${calibrationSteps}/${maxSteps}`);
                if (calibrationSteps >= maxSteps) {
                    clearInterval(calibrationInterval);
                    updateGNSSStatus('connected', '‚úÖ Sensores calibrados com sucesso');
                    if (appState.deviceWatchId) {
                        stopDeviceGNSS();
                        setTimeout(startDeviceGNSS, 1000);
                    }
                }
            }, 500);
        }

        function stopDeviceGNSS() {
            if (appState.deviceWatchId) {
                navigator.geolocation.clearWatch(appState.deviceWatchId);
                appState.deviceWatchId = null;
            }
            document.getElementById('deviceGnssText').textContent = 'üõ∞Ô∏è Ativar GNSS';
            updateGNSSStatus('disconnected', '‚èπÔ∏è Sistema GNSS do dispositivo parado');
        }

        function getLocationModeText(mode) {
            const modes = { 'device': 'GNSS do Dispositivo', 'rtk': 'Receptor RTK Externo', 'combined': 'Combinado (Device + RTK)' };
            return modes[mode] || mode;
        }

        function getGNSSSystemText(system) {
            const systems = { 'combined': 'Todos os Sistemas', 'gps': 'GPS', 'glonass': 'GLONASS', 'galileo': 'Galileo', 'beidou': 'BeiDou', 'qzss': 'QZSS' };
            return systems[system] || system;
        }

        function getAccuracyModeText(mode) {
            const modes = { 'high': 'Alta Precis√£o', 'balanced': 'Balanceado', 'low': 'Baixa Precis√£o' };
            return modes[mode] || mode;
        }

        function updateGNSSStatus(status, message) {
            const statusDiv = document.getElementById('gnssStatus');
            if (statusDiv) {
                statusDiv.className = `status ${status}`;
                statusDiv.textContent = message;
            }
        }

        // ================================
        // COLETA DE DADOS (MODIFICADO)
        // ================================
        function collectPoint(type = 'POINT') {
            const hasDeviceLocation = appState.locationMode === 'device' && appState.deviceWatchId;
            const hasRTKLocation = appState.locationMode === 'rtk' && appState.isConnected && appState.currentLocation.fixQuality > 0;
            const hasCombinedLocation = appState.locationMode === 'combined' && (appState.deviceWatchId || hasRTKLocation);
            
            if (!hasDeviceLocation && !hasRTKLocation && !hasCombinedLocation) {
                updateCollectionStatus('info', '‚ö†Ô∏è Ative um sistema de posicionamento com sinal v√°lido primeiro');
                return;
            }

            const description = document.getElementById('pointDescription').value || `Ponto ${appState.collectedPoints.length + 1}`;
            
            let locationSource = 'UNKNOWN';
            let accuracy = appState.currentLocation.accuracy || 999;
            
            if (appState.locationMode === 'device') {
                locationSource = `DEVICE-${getGNSSSystemText(appState.gnssType)}`;
            } else if (appState.locationMode === 'rtk') {
                locationSource = getFixQualityText(appState.currentLocation.fixQuality);
            } else if (appState.locationMode === 'combined') {
                locationSource = 'COMBINED';
            }
            
            const point = {
                id: Date.now(),
                type: type,
                latitude: appState.currentLocation.lat,
                longitude: appState.currentLocation.lon,
                altitude: appState.currentLocation.alt,
                accuracy: accuracy,
                satellites: appState.currentLocation.satellites,
                hdop: appState.currentLocation.hdop,
                locationSource: locationSource,
                rtkStatus: getFixQualityText(appState.currentLocation.fixQuality),
                description: description,
                timestamp: new Date().toISOString(),
                geometry: appState.currentGeometry,
            };

            appState.collectedPoints.push(point);
            saveDataToStorage();
            
            updateCollectionStatus('connected', `‚úÖ Ponto coletado via ${locationSource}! Precis√£o: ${point.accuracy.toFixed(3)}m`);
            document.getElementById('pointDescription').value = '';
            
            animateCollection();
            updateDataSummary();
        }

        function startLine() {
            if (!checkLocationAvailability()) return;
            appState.geometryType = 'LINE';
            appState.currentGeometry = 'LINE_' + Date.now();
            appState.isCollecting = true;
            updateCollectionStatus('connecting', 'üìè Modo LINHA ativo - Clique em "Coletar Ponto" para adicionar v√©rtices');
            document.getElementById('lineBtn').textContent = '‚èπÔ∏è Finalizar Linha';
            document.getElementById('lineBtn').setAttribute('onclick', 'finishLine()');
        }

        function finishLine() {
            appState.geometryType = 'POINT';
            appState.currentGeometry = null;
            appState.isCollecting = false;
            updateCollectionStatus('info', '‚úÖ Linha finalizada');
            document.getElementById('lineBtn').textContent = 'üìè Iniciar Linha';
            document.getElementById('lineBtn').setAttribute('onclick', 'startLine()');
        }

        function startPolygon() {
            if (!checkLocationAvailability()) return;
            appState.geometryType = 'POLYGON';
            appState.currentGeometry = 'POLYGON_' + Date.now();
            appState.isCollecting = true;
            updateCollectionStatus('connecting', 'üìê Modo POL√çGONO ativo - Clique em "Coletar Ponto" para adicionar v√©rtices');
            document.getElementById('polygonBtn').textContent = '‚èπÔ∏è Finalizar Pol√≠gono';
            document.getElementById('polygonBtn').setAttribute('onclick', 'finishPolygon()');
        }

        function finishPolygon() {
            appState.geometryType = 'POINT';
            appState.currentGeometry = null;
            appState.isCollecting = false;
            updateCollectionStatus('info', '‚úÖ Pol√≠gono finalizado');
            document.getElementById('polygonBtn').textContent = 'üìê Iniciar Pol√≠gono';
            document.getElementById('polygonBtn').setAttribute('onclick', 'startPolygon()');
        }

        function checkLocationAvailability() {
            const hasDeviceLocation = appState.locationMode === 'device' && appState.deviceWatchId;
            const hasRTKLocation = appState.locationMode === 'rtk' && appState.isConnected;
            const hasCombinedLocation = appState.locationMode === 'combined' && (appState.deviceWatchId || appState.isConnected);
            
            if (!hasDeviceLocation && !hasRTKLocation && !hasCombinedLocation) {
                updateCollectionStatus('info', 'Ative um sistema de posicionamento primeiro (aba GNSS ou Conex√£o)');
                return false;
            }
            return true;
        }

        function quickCollect() {
            collectPoint('POINT');
        }

        function animateCollection() {
            const btn = document.getElementById('collectPointBtn');
            btn.style.transform = 'scale(1.1)';
            btn.style.boxShadow = '0 0 20px #4CAF50';
            setTimeout(() => {
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = '';
            }, 300);
        }

        // ================================
        // GERENCIAMENTO DE DADOS E EXPORTA√á√ÉO (sem altera√ß√µes)
        // ================================

        function updateDataSummary() {
            const points = appState.collectedPoints.filter(p => p.type === 'POINT').length;
            const lines = new Set(appState.collectedPoints.filter(p => p.geometry && p.geometry.startsWith('LINE_')).map(p => p.geometry)).size;
            const polygons = new Set(appState.collectedPoints.filter(p => p.geometry && p.geometry.startsWith('POLYGON_')).map(p => p.geometry)).size;
            const avgAccuracy = appState.collectedPoints.length > 0 ? appState.collectedPoints.reduce((sum, p) => sum + p.accuracy, 0) / appState.collectedPoints.length : 0;
            document.getElementById('totalPoints').textContent = appState.collectedPoints.length;
            document.getElementById('totalLines').textContent = lines;
            document.getElementById('totalPolygons').textContent = polygons;
            document.getElementById('avgAccuracy').textContent = avgAccuracy > 0 ? avgAccuracy.toFixed(3) + ' m' : '-- m';
            updatePointsList();
        }

        function updatePointsList() {
            const listContainer = document.getElementById('pointsList');
            if (appState.collectedPoints.length === 0) {
                listContainer.innerHTML = `<div style="text-align: center; color: #666; padding: 20px;">Nenhum ponto coletado ainda<br><small>V√° para a aba "Coleta" para come√ßar</small></div>`;
                return;
            }
            const pointsHTML = appState.collectedPoints.map(point => `
                <div class="point-item">
                    <strong>${point.description}</strong><br>
                    <small>
                        ${point.latitude.toFixed(8)}¬∞, ${point.longitude.toFixed(8)}¬∞ | Precis√£o: ${point.accuracy.toFixed(3)}m | Qualidade: ${point.rtkStatus} | Sats: ${point.satellites} | HDOP: ${point.hdop}
                    </small>
                </div>`).join('');
            listContainer.innerHTML = pointsHTML;
        }

        function clearAllData() {
            if (confirm('Tem certeza que deseja apagar todos os dados coletados?')) {
                appState.collectedPoints = [];
                saveDataToStorage();
                updateDataSummary();
                updateCollectionStatus('info', 'Todos os dados foram removidos');
            }
        }

        function refreshData() {
            updateDataSummary();
            updateCollectionStatus('info', 'Dados atualizados');
        }

        function exportKMZ() {
            if (appState.collectedPoints.length === 0) {
                updateExportStatus('info', 'Nenhum ponto para exportar');
                return;
            }
            const projectName = document.getElementById('projectName').value || 'RTK_Collection';
            const precision = parseInt(document.getElementById('precision').value);
            let kmlContent = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>${projectName}</name>`;
            appState.collectedPoints.forEach(point => {
                kmlContent += `<Placemark><name>${point.description}</name><description>Precis√£o: ${point.accuracy.toFixed(3)}m | Qualidade: ${point.rtkStatus}</description><Point><coordinates>${point.longitude.toFixed(precision)},${point.latitude.toFixed(precision)},${point.altitude.toFixed(2)}</coordinates></Point></Placemark>`;
            });
            kmlContent += `</Document></kml>`;
            downloadFile(`${projectName}.kml`, kmlContent, 'application/vnd.google-earth.kml+xml');
            updateExportStatus('connected', `KMZ exportado: ${projectName}.kml`);
        }

        function exportGeoJSON() {
            if (appState.collectedPoints.length === 0) {
                updateExportStatus('info', 'Nenhum ponto para exportar');
                return;
            }
            const projectName = document.getElementById('projectName').value || 'RTK_Collection';
            const precision = parseInt(document.getElementById('precision').value);
            const geojson = {
                type: "FeatureCollection",
                features: appState.collectedPoints.map(point => ({
                    type: "Feature",
                    properties: { name: point.description, accuracy: point.accuracy, fix_quality: point.rtkStatus, satellites: point.satellites, hdop: point.hdop, timestamp: point.timestamp },
                    geometry: { type: "Point", coordinates: [parseFloat(point.longitude.toFixed(precision)), parseFloat(point.latitude.toFixed(precision)), parseFloat(point.altitude.toFixed(2))] }
                }))
            };
            downloadFile(`${projectName}.geojson`, JSON.stringify(geojson, null, 2), 'application/geo+json');
            updateExportStatus('connected', `GeoJSON exportado: ${projectName}.geojson`);
        }

        function exportCSV() {
            if (appState.collectedPoints.length === 0) {
                updateExportStatus('info', 'Nenhum ponto para exportar');
                return;
            }
            const projectName = document.getElementById('projectName').value || 'RTK_Collection';
            const precision = parseInt(document.getElementById('precision').value);
            let csvContent = 'ID,Nome,Latitude,Longitude,Altitude,Precisao,Qualidade_Fix,Satelites,HDOP,Data_Coleta\n';
            appState.collectedPoints.forEach((point, index) => {
                csvContent += `${index + 1},"${point.description}",${point.latitude.toFixed(precision)},${point.longitude.toFixed(precision)},${point.altitude.toFixed(2)},${point.accuracy.toFixed(3)},"${point.rtkStatus}",${point.satellites},"${point.hdop || 'N/A'}","${point.timestamp}"\n`;
            });
            downloadFile(`${projectName}.csv`, csvContent, 'text/csv');
            updateExportStatus('connected', `CSV exportado: ${projectName}.csv`);
        }

        function exportGeoPackage() {
            updateExportStatus('info', 'GeoPackage em desenvolvimento - Use GeoJSON ou CSV.');
        }

        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function saveDataToStorage() {
            try { localStorage.setItem('rtkCollectorAppState', JSON.stringify(appState)); } 
            catch (error) { console.warn('Erro ao salvar dados:', error); }
        }

        function loadStoredData() {
            try {
                const storedState = localStorage.getItem('rtkCollectorAppState');
                if (storedState) {
                    const loadedState = JSON.parse(storedState);
                    appState.collectedPoints = loadedState.collectedPoints || [];
                    appState.locationMode = loadedState.locationMode || 'device';
                    appState.gnssType = loadedState.gnssType || 'combined';
                    document.getElementById('locationMode').value = appState.locationMode;
                    document.getElementById('gnssSystem').value = appState.gnssType;
                    updateDataSummary();
                }
            } catch (error) { console.warn('Erro ao carregar dados:', error); }
        }

        function startLocationUpdates() {
            if (navigator.geolocation) {
                console.log('Sistema de localiza√ß√£o pronto para uso');
            } else {
                console.warn('Geolocaliza√ß√£o n√£o suportada');
                updateGNSSStatus('disconnected', 'Geolocaliza√ß√£o n√£o suportada neste dispositivo');
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            const clickedTab = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
            if (clickedTab) clickedTab.classList.add('active');
            if (tabName === 'data') updateDataSummary();
        }

        function updateConnectionStatus(status, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
        }

        function updateCollectionStatus(status, message) {
            const statusDiv = document.getElementById('collectionStatus');
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
        }

        function updateExportStatus(status, message) {
            const statusDiv = document.getElementById('exportStatus');
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
        }

        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case 'Enter': event.preventDefault(); quickCollect(); break;
                    case 's': event.preventDefault(); exportGeoJSON(); break;
                }
            }
        });
        
        setInterval(saveDataToStorage, 60000);
    </script>
</body>
</html>
