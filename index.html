<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTK Data Collector</title>
    
    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#2196F3">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(90deg, #2196F3, #21CBF3);
            border-radius: 15px 15px 0 0;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.1; transform: scale(1.1); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            margin: 20px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }

        .content {
            padding: 20px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            border-left: 5px solid;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .status.connected {
            background: #e8f5e8;
            color: #2e7d32;
            border-color: #4caf50;
        }

        .status.connecting {
            background: #fff3e0;
            color: #ef6c00;
            border-color: #ff9800;
        }

        .status.disconnected {
            background: #ffebee;
            color: #c62828;
            border-color: #f44336;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #2196f3;
        }

        .data-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .data-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .data-item:hover {
            border-color: #2196F3;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);
        }

        .data-item .label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .data-item .value {
            font-size: 1.4em;
            font-weight: bold;
            color: #2196F3;
        }

        .points-list {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .point-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .point-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 25px 0;
        }

        .map-container {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #666;
            position: relative;
        }

        .map-container::before {
            content: 'üó∫Ô∏è';
            font-size: 3em;
            opacity: 0.3;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
                margin: 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                padding: 12px 25px;
            }
            
            .data-display {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-action:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 30px rgba(76, 175, 80, 0.6);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° RTK Data Collector</h1>
            <p>Sistema Amador de Coleta GNSS/RTK</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('connection')">üîó Conex√£o</button>
            <button class="tab" onclick="showTab('gnss')">üõ∞Ô∏è GNSS</button>
            <button class="tab" onclick="showTab('collection')">üìç Coleta</button>
            <button class="tab" onclick="showTab('data')">üìä Dados</button>
            <button class="tab" onclick="showTab('export')">üíæ Exportar</button>
        </div>

        <div class="content">
            <div id="gnss" class="tab-content">
                <div class="card">
                    <h3>üì± Sistema de Posicionamento do Dispositivo</h3>
                    <div class="form-group">
                        <label>Modo de Localiza√ß√£o:</label>
                        <select class="form-control" id="locationMode" onchange="changeLocationMode()">
                            <option value="device">üì± GNSS do Dispositivo</option>
                            <option value="rtk">üõ∞Ô∏è Receptor RTK Externo (Serial/USB)</option>
                            <option value="combined">üîÑ Combinado (Device + RTK)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Sistemas GNSS Dispon√≠veis:</label>
                        <select class="form-control" id="gnssSystem" onchange="changeGNSSSystem()">
                            <option value="combined">üåç Todos os Sistemas (Recomendado)</option>
                            <option value="gps">üá∫üá∏ GPS (Estados Unidos)</option>
                            <option value="glonass">üá∑üá∫ GLONASS (R√∫ssia)</option>
                            <option value="galileo">üá™üá∫ Galileo (Uni√£o Europeia)</option>
                            <option value="beidou">üá®üá≥ BeiDou (China)</option>
                            <option value="qzss">üáØüáµ QZSS (Jap√£o)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Configura√ß√µes de Precis√£o:</label>
                        <select class="form-control" id="accuracyMode" onchange="changeAccuracyMode()">
                            <option value="high">üéØ Alta Precis√£o (Mais lento, mais bateria)</option>
                            <option value="balanced">‚öñÔ∏è Balanceado (Recomendado)</option>
                            <option value="low">‚ö° Baixa Precis√£o (Mais r√°pido, menos bateria)</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="startDeviceGNSS()">
                            <span id="deviceGnssText">üõ∞Ô∏è Ativar GNSS</span>
                        </button>
                        <button class="btn btn-warning" onclick="calibrateDevice()">üß≠ Calibrar Sensores</button>
                        <button class="btn btn-danger" onclick="stopDeviceGNSS()">‚èπÔ∏è Parar GNSS</button>
                    </div>

                    <div id="gnssStatus" class="status info">
                        ‚ÑπÔ∏è GNSS do dispositivo pronto para uso
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Informa√ß√µes dos Sat√©lites (GNSS Interno √© Simulado)</h3>
                    <div class="data-display">
                        <div class="data-item">
                            <div class="label">GPS</div>
                            <div class="value" id="gpsCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">GLONASS</div>
                            <div class="value" id="glonassCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Galileo</div>
                            <div class="value" id="galileoCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">BeiDou</div>
                            <div class="value" id="beidouCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">QZSS</div>
                            <div class="value" id="qzssCount">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">HDOP</div>
                            <div class="value" id="hdopValue">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="connection" class="tab-content active">
                <div class="card">
                    <h3>üîå Receptor GNSS Externo (Serial/USB)</h3>
                    <div class="form-group">
                        <label>Velocidade (Baud Rate):</label>
                        <select class="form-control" id="baudRate">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200" selected>115200</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="connectSerial()">
                            <span id="serialConnectText">üîå Conectar via Serial/USB</span>
                        </button>
                        <button class="btn btn-danger" onclick="disconnect()">‚ùå Desconectar</button>
                    </div>
                    <div id="connectionStatus" class="status disconnected">
                        ‚ùå Desconectado - Conecte o receptor na porta USB e clique para conectar
                    </div>
                </div>
            </div>

            <div id="collection" class="tab-content">
                <div class="card">
                    <h3>üìç Dados GNSS Atuais</h3>
                    <div class="data-display">
                        <div class="data-item">
                            <div class="label">Latitude</div>
                            <div class="value" id="currentLat">--¬∞</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Longitude</div>
                            <div class="value" id="currentLon">--¬∞</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Altitude</div>
                            <div class="value" id="currentAlt">-- m</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Precis√£o</div>
                            <div class="value" id="currentAccuracy">-- m</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Sat√©lites</div>
                            <div class="value" id="satellites">--</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Qualidade Fix</div>
                            <div class="value" id="activeSystem">INATIVO</div>
                        </div>
                    </div>
                    
                    <div id="positioningStatus" class="status info">
                        ‚ÑπÔ∏è Escolha um sistema de posicionamento na aba GNSS
                    </div>
                </div>

                <div class="card">
                    <h3>üéØ Tipos de Coleta</h3>
                    <div class="button-group">
                        <button class="btn btn-success" onclick="collectPoint('POINT')" id="collectPointBtn">
                            üìç Coletar Ponto
                        </button>
                        <button class="btn btn-success" onclick="startLine()" id="lineBtn">
                            üìè Iniciar Linha
                        </button>
                        <button class="btn btn-success" onclick="startPolygon()" id="polygonBtn">
                            üìê Iniciar Pol√≠gono
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Descri√ß√£o do Ponto:</label>
                        <input type="text" class="form-control" id="pointDescription" placeholder="Ex: Marco, Poste, Edifica√ß√£o...">
                    </div>

                    <div id="collectionStatus" class="status info">
                        ‚ÑπÔ∏è Pronto para coletar - Selecione o tipo de geometria
                    </div>
                </div>

                <div class="map-container">
                    <div style="text-align: center;">
                        üó∫Ô∏è Mapa Interativo<br>
                        <small>Visualiza√ß√£o dos pontos coletados</small>
                    </div>
                </div>
            </div>

            <div id="data" class="tab-content">
                <div class="card">
                    <h3>üìä Resumo da Coleta</h3>
                    <div class="data-display">
                        <div class="data-item">
                            <div class="label">Total Pontos</div>
                            <div class="value" id="totalPoints">0</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Linhas</div>
                            <div class="value" id="totalLines">0</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Pol√≠gonos</div>
                            <div class="value" id="totalPolygons">0</div>
                        </div>
                        <div class="data-item">
                            <div class="label">Precis√£o M√©dia</div>
                            <div class="value" id="avgAccuracy">-- m</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìã Lista de Pontos Coletados</h3>
                    <div class="button-group">
                        <button class="btn btn-warning" onclick="clearAllData()">üóëÔ∏è Limpar Tudo</button>
                        <button class="btn btn-primary" onclick="refreshData()">üîÑ Atualizar</button>
                    </div>
                    <div id="pointsList" class="points-list">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            üìç Nenhum ponto coletado ainda<br>
                            <small>V√° para a aba "Coleta" para come√ßar</small>
                        </div>
                    </div>
                </div>
            </div>

            <div id="export" class="tab-content">
                <div class="card">
                    <h3>üíæ Exportar Dados</h3>
                    <div class="form-group">
                        <label>Nome do Projeto:</label>
                        <input type="text" class="form-control" id="projectName" placeholder="Ex: Levantamento_Area_01">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="exportKMZ()">üó∫Ô∏è Exportar KMZ</button>
                        <button class="btn btn-primary" onclick="exportGeoJSON()">üåê Exportar GeoJSON</button>
                        <button class="btn btn-primary" onclick="exportCSV()">üìä Exportar CSV</button>
                        <button class="btn btn-primary" onclick="exportGeoPackage()">üì¶ Exportar GeoPackage</button>
                    </div>
                    
                    <div id="exportStatus" class="status info">
                        üí° Selecione o formato desejado para exporta√ß√£o
                    </div>
                </div>

                <div class="card">
                    <h3>‚öôÔ∏è Configura√ß√µes de Exporta√ß√£o</h3>
                    <div class="form-group">
                        <label>Sistema de Coordenadas:</label>
                        <select class="form-control" id="coordinateSystem">
                            <option value="WGS84">WGS84 (GPS)</option>
                            <option value="SIRGAS2000">SIRGAS 2000</option>
                            <option value="UTM">UTM</option>
                            <option value="SAD69">SAD 69</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Precis√£o Decimal:</label>
                        <select class="form-control" id="precision">
                            <option value="6">6 casas (¬±1m)</option>
                            <option value="7">7 casas (¬±10cm)</option>
                            <option value="8">8 casas (¬±1cm)</option>
                            <option value="9">9 casas (¬±1mm)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="floating-action" onclick="quickCollect()" title="Coleta R√°pida">
        ‚ö°
    </button>

    <script>
        // Vari√°veis globais para a conex√£o serial
        let port;
        let reader;
        let keepReading = false;

        // Estado global da aplica√ß√£o
        let appState = {
            isConnected: false,
            collectedPoints: [],
            currentGeometry: null,
            geometryType: 'POINT',
            isCollecting: false,
            currentLocation: { lat: 0, lon: 0, alt: 0, accuracy: 0, satellites: 0, fixQuality: 0, hdop: 0 },
            locationMode: 'device', // 'device', 'rtk', 'combined'
            gnssType: 'combined', // 'gps', 'glonass', 'galileo', 'beidou', 'qzss', 'combined'
            deviceWatchId: null,
            locationHistory: []
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            initializePWA();
            loadStoredData();
            initializeGNSSSystem();
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('Service Worker registrado com sucesso:', registration))
                    .catch(error => console.log('Falha no registro do Service Worker:', error));
            }
        });

        function initializePWA() {
            console.log('üöÄ RTK Data Collector PWA Inicializado');
            updateConnectionStatus('disconnected', '‚ùå Aguardando conex√£o com receptor GNSS');
            updateGNSSStatus('info', '‚ÑπÔ∏è Sistema GNSS do dispositivo dispon√≠vel');
        }

        function initializeGNSSSystem() {
            if (navigator.geolocation) {
                requestLocationPermissions();
            } else {
                updateGNSSStatus('disconnected', '‚ùå Sistema GNSS n√£o dispon√≠vel neste dispositivo');
            }
        }

        async function requestLocationPermissions() {
            try {
                if ('permissions' in navigator) {
                    await navigator.permissions.query({name: 'geolocation'});
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel verificar permiss√µes:', error);
            }
        }
        
        // ================================
        // CONEX√ÉO SERIAL/USB
        // ================================
        async function connectSerial() {
            if (!("serial" in navigator)) {
                alert("Seu navegador n√£o suporta a Web Serial API. Use o Google Chrome ou Microsoft Edge na vers√£o mais recente.");
                return;
            }

            if (appState.isConnected) {
                return;
            }

            const connectBtn = document.getElementById('serialConnectText');
            connectBtn.innerHTML = '<span class="loading"></span>Conectando...';
            updateConnectionStatus('connecting', 'üîÑ Aguardando sele√ß√£o da porta serial...');

            try {
                port = await navigator.serial.requestPort();
                keepReading = true;
                appState.isConnected = true;
                
                const baudRate = parseInt(document.getElementById('baudRate').value, 10);
                await port.open({ baudRate: baudRate });
                
                updateConnectionStatus('connected', '‚úÖ Conectado ao receptor GNSS via Serial/USB');
                connectBtn.textContent = '‚úÖ Conectado';

                readFromSerial();

            } catch (error) {
                console.error('‚ùå Erro na conex√£o Serial:', error);
                updateConnectionStatus('disconnected', '‚ùå Erro: ' + error.message);
                connectBtn.textContent = 'üîå Conectar via Serial/USB';
                appState.isConnected = false;
            }
        }

        async function readFromSerial() {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();

            let lineBuffer = '';

            while (port.readable && keepReading) {
                try {
                    const { value, done } = await reader.read();
                    if (done) break;

                    lineBuffer += value;
                    let lines = lineBuffer.split('\r\n');
                    lineBuffer = lines.pop(); 
                    
                    lines.forEach(line => {
                        if (line.startsWith('$GNGGA') || line.startsWith('$GPGGA')) {
                            parseNMEA_GGA(line);
                        }
                    });

                } catch (error) {
                    console.error("Erro ao ler da porta serial:", error);
                    break;
                }
            }
            
            if (reader) reader.releaseLock();
            await readableStreamClosed.catch(() => {});
        }
        
        // PARSER DE DADOS REAIS DO RECEPTOR EXTERNO
        function parseNMEA_GGA(sentence) {
            const parts = sentence.split(',');
            if (parts.length < 10) return;

            const fixQuality = parseInt(parts[6], 10);
            if (fixQuality === 0) {
                updateLocationDisplayWithStatus("Sem Sinal", 0);
                return;
            }
            
            const latValue = parseFloat(parts[2]);
            const latDirection = parts[3];
            let latitude = Math.floor(latValue / 100) + (latValue % 100) / 60;
            if (latDirection === 'S') latitude *= -1;

            const lonValue = parseFloat(parts[4]);
            const lonDirection = parts[5];
            let longitude = Math.floor(lonValue / 100) + (lonValue % 100) / 60;
            if (lonDirection === 'W') longitude *= -1;

            const satellites = parseInt(parts[7], 10);
            const hdop = parseFloat(parts[8]);
            const altitude = parseFloat(parts[9]);

            let accuracy = hdop * 2;
            if (fixQuality === 4 || fixQuality === 5) {
                accuracy = 0.02 + (hdop * 0.05);
            }

            appState.currentLocation = {
                lat: latitude,
                lon: longitude,
                alt: altitude,
                accuracy: accuracy,
                satellites: satellites,
                hdop: hdop,
                fixQuality: fixQuality
            };
            
            resetSatelliteDisplay(); // Limpa a simula√ß√£o do modo interno
            document.getElementById('gpsCount').textContent = "N/A";
            document.getElementById('glonassCount').textContent = "N/A";

            if (appState.locationMode === 'rtk' || appState.locationMode === 'combined') {
                updateLocationDisplay();
            }
        }
        
        async function disconnect() {
            keepReading = false;
            if (reader) {
                await reader.cancel().catch(() => {});
            }
            if (port) {
                await port.close().catch(() => {});
                port = null;
            }
            appState.isConnected = false;
            document.getElementById('serialConnectText').textContent = 'üîå Conectar via Serial/USB';
            updateConnectionStatus('disconnected', '‚ùå Desconectado do receptor GNSS');
        }

        // ================================
        // GNSS DO DISPOSITIVO (COM SIMULA√á√ÉO VISUAL)
        // ================================

        function changeLocationMode() {
            const mode = document.getElementById('locationMode').value;
            appState.locationMode = mode;
        }

        function changeGNSSSystem() {
            appState.gnssType = document.getElementById('gnssSystem').value;
        }

        function changeAccuracyMode() {
            if (appState.deviceWatchId) {
                stopDeviceGNSS();
                startDeviceGNSS();
            }
        }

        async function startDeviceGNSS() {
            if (!navigator.geolocation) {
                updateGNSSStatus('disconnected', '‚ùå Geolocaliza√ß√£o n√£o suportada');
                return;
            }
            if(appState.deviceWatchId) return;

            const button = document.getElementById('deviceGnssText');
            button.innerHTML = '<span class="loading"></span>Iniciando...';
            updateGNSSStatus('connecting', 'üîÑ Iniciando GNSS do dispositivo...');

            try {
                const options = getLocationOptions();
                appState.deviceWatchId = navigator.geolocation.watchPosition(
                    handleDeviceLocation,
                    handleLocationError,
                    options
                );
                button.textContent = '‚úÖ GNSS Ativo';
                updateGNSSStatus('connected', `‚úÖ GNSS do dispositivo ativo.`);
            } catch (error) {
                updateGNSSStatus('disconnected', '‚ùå Erro: ' + error.message);
                button.textContent = 'üõ∞Ô∏è Ativar GNSS';
            }
        }

        function handleDeviceLocation(position) {
            const { coords } = position;
            if (appState.locationMode === 'device' || appState.locationMode === 'combined') {
                appState.currentLocation = {
                    lat: coords.latitude,
                    lon: coords.longitude,
                    alt: coords.altitude || 0,
                    accuracy: coords.accuracy || 999,
                    satellites: estimateSatelliteCount(coords.accuracy),
                    hdop: calculateHDOP(coords.accuracy),
                    fixQuality: 1, // Simula um fix de GPS padr√£o
                };
                simulateSatelliteInfo(); // ATUALIZA A SIMULA√á√ÉO VISUAL
                updateLocationDisplay();
            }
        }

        function handleLocationError(error) {
            let msg = error.code === 1 ? 'Permiss√£o negada' : 'Posi√ß√£o indispon√≠vel';
            updateGNSSStatus('disconnected', '‚ùå ' + msg);
        }

        function stopDeviceGNSS() {
            if (appState.deviceWatchId) {
                navigator.geolocation.clearWatch(appState.deviceWatchId);
                appState.deviceWatchId = null;
            }
            document.getElementById('deviceGnssText').textContent = 'üõ∞Ô∏è Ativar GNSS';
            updateGNSSStatus('info', '‚ÑπÔ∏è GNSS do dispositivo parado.');
            resetSatelliteDisplay();
        }
        
        // FUN√á√ïES DE SIMULA√á√ÉO VISUAL PARA GNSS INTERNO
        function estimateSatelliteCount(accuracy) {
            if (accuracy < 3) return 15;
            if (accuracy < 5) return 12;
            if (accuracy < 10) return 8;
            if (accuracy < 20) return 5;
            return 4;
        }

        function calculateHDOP(accuracy) {
            return Math.min(Math.max(1, accuracy / 2.5), 10).toFixed(1);
        }

        function simulateSatelliteInfo() {
            const totalSats = appState.currentLocation.satellites;
            const distribution = { gps: 0, glonass: 0, galileo: 0, beidou: 0, qzss: 0 };
            const selectedSystem = appState.gnssType;

            if (selectedSystem === 'combined') {
                distribution.gps = Math.round(totalSats * 0.4);
                distribution.glonass = Math.round(totalSats * 0.25);
                distribution.galileo = Math.round(totalSats * 0.2);
                distribution.beidou = Math.round(totalSats * 0.15);
            } else {
                distribution[selectedSystem] = totalSats;
            }
            
            document.getElementById('gpsCount').textContent = distribution.gps;
            document.getElementById('glonassCount').textContent = distribution.glonass;
            document.getElementById('galileoCount').textContent = distribution.galileo;
            document.getElementById('beidouCount').textContent = distribution.beidou;
            document.getElementById('qzssCount').textContent = distribution.qzss;
        }

        function resetSatelliteDisplay() {
            document.getElementById('gpsCount').textContent = '--';
            document.getElementById('glonassCount').textContent = '--';
            document.getElementById('galileoCount').textContent = '--';
            document.getElementById('beidouCount').textContent = '--';
            document.getElementById('qzssCount').textContent = '--';
        }

        // ================================
        // ATUALIZA√á√ÉO DA INTERFACE
        // ================================
        function updateLocationDisplay() {
            const loc = appState.currentLocation;
            document.getElementById('currentLat').textContent = loc.lat.toFixed(8) + '¬∞';
            document.getElementById('currentLon').textContent = loc.lon.toFixed(8) + '¬∞';
            document.getElementById('currentAlt').textContent = loc.alt.toFixed(2) + ' m';
            document.getElementById('currentAccuracy').textContent = loc.accuracy.toFixed(2) + ' m';
            document.getElementById('satellites').textContent = loc.satellites;
            document.getElementById('hdopValue').textContent = loc.hdop || '--';
            
            let activeSystemText = 'INATIVO';
            let statusClass = 'disconnected';
            let statusMessage = 'Nenhum sistema de posicionamento ativo';
            
            if (appState.locationMode === 'device' && appState.deviceWatchId) {
                activeSystemText = 'GNSS INTERNO';
                statusClass = 'connected';
                statusMessage = `‚úÖ Sistema GNSS do dispositivo ativo`;
            } else if (appState.locationMode === 'rtk' && appState.isConnected) {
                activeSystemText = getFixQualityText(loc.fixQuality);
                statusClass = loc.fixQuality >= 2 ? 'connected' : 'connecting';
                statusMessage = `‚úÖ Receptor Externo ativo - Qualidade: ${activeSystemText}`;
            }
            
            document.getElementById('activeSystem').textContent = activeSystemText;
            document.getElementById('positioningStatus').className = `status ${statusClass}`;
            document.getElementById('positioningStatus').textContent = statusMessage;
        }

        function updateLocationDisplayWithStatus(statusText, fixQuality) {
            document.getElementById('activeSystem').textContent = statusText;
            appState.currentLocation.fixQuality = fixQuality;
        }

        function getFixQualityText(quality) {
            const qualityMap = { 1: 'SINGLE', 2: 'DGPS', 4: 'RTK FIXED', 5: 'RTK FLOAT' };
            return qualityMap[quality] || 'SEM SINAL';
        }

        // ================================
        // COLETA DE DADOS
        // ================================
        function collectPoint(type = 'POINT') {
            const hasLocation = (appState.locationMode === 'device' && appState.deviceWatchId) || (appState.locationMode === 'rtk' && appState.isConnected && appState.currentLocation.fixQuality > 0);
            if (!hasLocation) {
                updateCollectionStatus('info', '‚ö†Ô∏è Ative um sistema de posicionamento com sinal v√°lido');
                return;
            }

            const description = document.getElementById('pointDescription').value || `Ponto ${appState.collectedPoints.length + 1}`;
            const loc = appState.currentLocation;
            
            const point = {
                id: Date.now(),
                type,
                latitude: loc.lat,
                longitude: loc.lon,
                altitude: loc.alt,
                accuracy: loc.accuracy,
                satellites: loc.satellites,
                hdop: loc.hdop,
                locationSource: appState.locationMode === 'device' ? 'GNSS Interno' : getFixQualityText(loc.fixQuality),
                description,
                timestamp: new Date().toISOString(),
                geometry: appState.currentGeometry,
            };

            appState.collectedPoints.push(point);
            saveDataToStorage();
            updateCollectionStatus('connected', `‚úÖ Ponto coletado via ${point.locationSource}! Precis√£o: ${point.accuracy.toFixed(3)}m`);
            document.getElementById('pointDescription').value = '';
            animateCollection();
            updateDataSummary();
        }

        function startLine() {
            appState.currentGeometry = 'LINE_' + Date.now();
            updateCollectionStatus('connecting', 'üìè Modo LINHA ativo');
            document.getElementById('lineBtn').textContent = '‚èπÔ∏è Finalizar Linha';
            document.getElementById('lineBtn').setAttribute('onclick', 'finishGeometry()');
        }

        function startPolygon() {
            appState.currentGeometry = 'POLYGON_' + Date.now();
            updateCollectionStatus('connecting', 'üìê Modo POL√çGONO ativo');
            document.getElementById('polygonBtn').textContent = '‚èπÔ∏è Finalizar Pol√≠gono';
            document.getElementById('polygonBtn').setAttribute('onclick', 'finishGeometry()');
        }

        function finishGeometry() {
            appState.currentGeometry = null;
            updateCollectionStatus('info', '‚úÖ Geometria finalizada');
            document.getElementById('lineBtn').textContent = 'üìè Iniciar Linha';
            document.getElementById('lineBtn').setAttribute('onclick', 'startLine()');
            document.getElementById('polygonBtn').textContent = 'üìê Iniciar Pol√≠gono';
            document.getElementById('polygonBtn').setAttribute('onclick', 'startPolygon()');
        }

        function quickCollect() {
            collectPoint('POINT');
        }

        function animateCollection() {
            const btn = document.getElementById('collectPointBtn');
            btn.style.transform = 'scale(1.1)';
            setTimeout(() => btn.style.transform = 'scale(1)', 300);
        }

        // ================================
        // GERENCIAMENTO E EXPORTA√á√ÉO DE DADOS
        // ================================
        function updateDataSummary() {
            const points = appState.collectedPoints;
            const lines = new Set(points.map(p => p.geometry).filter(g => g && g.startsWith('LINE_'))).size;
            const polygons = new Set(points.map(p => p.geometry).filter(g => g && g.startsWith('POLYGON_'))).size;
            const avgAccuracy = points.length ? points.reduce((sum, p) => sum + p.accuracy, 0) / points.length : 0;
            
            document.getElementById('totalPoints').textContent = points.length;
            document.getElementById('totalLines').textContent = lines;
            document.getElementById('totalPolygons').textContent = polygons;
            document.getElementById('avgAccuracy').textContent = avgAccuracy ? avgAccuracy.toFixed(3) + ' m' : '-- m';
            updatePointsList();
        }

        function updatePointsList() {
            const listContainer = document.getElementById('pointsList');
            if (!appState.collectedPoints.length) {
                listContainer.innerHTML = `<div style="text-align: center; color: #666; padding: 20px;">Nenhum ponto coletado ainda</div>`;
                return;
            }
            listContainer.innerHTML = appState.collectedPoints.map(point => `
                <div class="point-item">
                    <strong>${point.description}</strong><br>
                    <small>Lat: ${point.latitude.toFixed(7)}, Lon: ${point.longitude.toFixed(7)} | Precis√£o: ${point.accuracy.toFixed(3)}m | Qualidade: ${point.locationSource}</small>
                </div>`).join('');
        }

        function clearAllData() {
            if (confirm('Tem certeza que deseja apagar todos os dados?')) {
                appState.collectedPoints = [];
                saveDataToStorage();
                updateDataSummary();
            }
        }

        function refreshData() {
            updateDataSummary();
        }

        function exportData(format) {
            if (!appState.collectedPoints.length) {
                updateExportStatus('info', 'Nenhum ponto para exportar');
                return;
            }
            const projectName = document.getElementById('projectName').value || 'RTK_Collection';
            const precision = parseInt(document.getElementById('precision').value);
            let content, mimeType, extension;

            switch(format) {
                case 'kmz':
                    extension = 'kml';
                    mimeType = 'application/vnd.google-earth.kml+xml';
                    content = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>${projectName}</name>`;
                    appState.collectedPoints.forEach(p => {
                        content += `<Placemark><name>${p.description}</name><description>Precis√£o: ${p.accuracy.toFixed(3)}m, Qualidade: ${p.locationSource}</description><Point><coordinates>${p.longitude.toFixed(precision)},${p.latitude.toFixed(precision)},${p.altitude.toFixed(2)}</coordinates></Point></Placemark>`;
                    });
                    content += `</Document></kml>`;
                    break;
                case 'geojson':
                    extension = 'geojson';
                    mimeType = 'application/geo+json';
                    const features = appState.collectedPoints.map(p => ({
                        type: "Feature",
                        properties: { name: p.description, accuracy: p.accuracy, fix_quality: p.locationSource, satellites: p.satellites, hdop: p.hdop, timestamp: p.timestamp },
                        geometry: { type: "Point", coordinates: [parseFloat(p.longitude.toFixed(precision)), parseFloat(p.latitude.toFixed(precision)), parseFloat(p.altitude.toFixed(2))] }
                    }));
                    content = JSON.stringify({ type: "FeatureCollection", features }, null, 2);
                    break;
                case 'csv':
                    extension = 'csv';
                    mimeType = 'text/csv';
                    content = 'ID,Nome,Latitude,Longitude,Altitude,Precisao,Qualidade_Fix,Satelites,HDOP,Data_Coleta\n';
                    appState.collectedPoints.forEach((p, i) => {
                        content += `${i + 1},"${p.description}",${p.latitude.toFixed(precision)},${p.longitude.toFixed(precision)},${p.altitude.toFixed(2)},${p.accuracy.toFixed(3)},"${p.locationSource}",${p.satellites},"${p.hdop || 'N/A'}","${p.timestamp}"\n`;
                    });
                    break;
                default: return;
            }
            downloadFile(`${projectName}.${extension}`, content, mimeType);
            updateExportStatus('connected', `Exportado: ${projectName}.${extension}`);
        }
        
        const exportKMZ = () => exportData('kmz');
        const exportGeoJSON = () => exportData('geojson');
        const exportCSV = () => exportData('csv');
        
        function exportGeoPackage() {
            updateExportStatus('info', 'GeoPackage n√£o suportado. Use GeoJSON ou CSV.');
        }

        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        // ================================
        // UTILIT√ÅRIOS E NAVEGA√á√ÉO
        // ================================
        function saveDataToStorage() {
            try {
                const stateToSave = { collectedPoints: appState.collectedPoints, locationMode: appState.locationMode, gnssType: appState.gnssType };
                localStorage.setItem('rtkCollectorAppState', JSON.stringify(stateToSave));
            } catch (e) { console.warn('Erro ao salvar dados:', e); }
        }

        function loadStoredData() {
            try {
                const storedState = localStorage.getItem('rtkCollectorAppState');
                if (storedState) {
                    const loaded = JSON.parse(storedState);
                    appState.collectedPoints = loaded.collectedPoints || [];
                    appState.locationMode = loaded.locationMode || 'device';
                    appState.gnssType = loaded.gnssType || 'combined';
                    document.getElementById('locationMode').value = appState.locationMode;
                    document.getElementById('gnssSystem').value = appState.gnssType;
                    updateDataSummary();
                }
            } catch (e) { console.warn('Erro ao carregar dados:', e); }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'data') updateDataSummary();
        }

        const updateStatus = (id, status, message) => {
            const div = document.getElementById(id);
            div.className = `status ${status}`;
            div.textContent = message;
        };

        const updateConnectionStatus = (s, m) => updateStatus('connectionStatus', s, m);
        const updateGNSSStatus = (s, m) => updateStatus('gnssStatus', s, m);
        const updateCollectionStatus = (s, m) => updateStatus('collectionStatus', s, m);
        const updateExportStatus = (s, m) => updateStatus('exportStatus', s, m);

        setInterval(saveDataToStorage, 60000);
    </script>
</body>
</html>
